version: '3.8'

services:
  typescript-service:
    build:
      context: .
      dockerfile: Dockerfile.typescript
    ports:
      - "${API_PORT:-3000}:3000"
    environment:
      - NODE_ENV=development
      - RPC_ENDPOINT=${RPC_ENDPOINT}
      - ALCHEMY_API_KEY=${ALCHEMY_API_KEY}
      - JITO_ENDPOINT=${JITO_ENDPOINT}
      - JITO_AUTH_KEYPAIR_BASE64=${JITO_AUTH_KEYPAIR_BASE64}
      - API_PORT=${API_PORT:-3000}
      - API_HOST=0.0.0.0
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - DISABLE_NOTIFICATIONS=true
    restart: always
    volumes:
      - ./ts-src:/app/ts-src
      - ./keys:/app/keys
      - ./logs:/app/logs
      - ./data:/app/data
      - ./jito-ts:/app/jito-ts

  python-service:
    build:
      context: .
      dockerfile: Dockerfile.python
    environment:
      - PYTHONUNBUFFERED=1
      - API_HOST=typescript-service
      - API_PORT=${API_PORT:-3000}
      - ALCHEMY_API_KEY=${ALCHEMY_API_KEY}
      - RPC_ENDPOINT=${RPC_ENDPOINT}
      - JITO_ENDPOINT=${JITO_ENDPOINT}
      - JITO_AUTH_KEYPAIR_BASE64=${JITO_AUTH_KEYPAIR_BASE64}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - MAX_RISK_SCORE=50
      - ACCEPT_ALL_TOKEN_PAIRS=true
      - DISABLE_NOTIFICATIONS=true
    depends_on:
      - typescript-service
    restart: always
    volumes:
      - .:/app
      - ./data:/app/data:rw

  liquidity-monitor:
    build:
      context: .
      dockerfile: Dockerfile.typescript
    environment:
      - NODE_ENV=development
      - RPC_ENDPOINT=${RPC_ENDPOINT}
      - ALCHEMY_API_KEY=${ALCHEMY_API_KEY}
      - JITO_ENDPOINT=${JITO_ENDPOINT}
      - JITO_AUTH_KEYPAIR_BASE64=${JITO_AUTH_KEYPAIR_BASE64}
      - API_PORT=${API_PORT:-3000}
      - API_HOST=typescript-service
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - DISABLE_NOTIFICATIONS=true
    command: node dist/monitor-liquidity-enhanced.js
    depends_on:
      - typescript-service
    restart: always
    volumes:
      - ./ts-src:/app/ts-src
      - ./keys:/app/keys
      - ./data:/app/data:rw
      - ./jito-ts:/app/jito-ts

  watchtower:
    image: containrrr/watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --interval 3600
    restart: always